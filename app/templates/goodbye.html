<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#000000" />
    <title>Signed out</title>
    <style>
      html,body{ margin:0; padding:0; height:100%; background:#0b0f19; color:#fff; font:16px/1.4 system-ui,Segoe UI,Roboto,Arial; }
      .wrap{ min-height:100%; display:grid; place-items:center; padding:24px; text-align:center; }
      .card{ background:#121826; border:1px solid #1f2937; border-radius:16px; padding:24px; max-width:420px; width:100%; display:grid; gap:12px; }
      h1{ margin:0; font-size:20px; }
      p{ margin:0; opacity:.8; }
      .row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
      .btn{ appearance:none; border:1px solid #334155; background:#1f2937; color:#e5e7eb; padding:12px 16px; border-radius:10px; cursor:pointer; text-decoration:none; min-height:44px; }
      .btn.primary{ background:#16a34a; border-color:#16a34a; color:#fff; font-weight:600; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Signed out</h1>
        <p>You can now close this app.</p>
        <div class="row">
          <button id="closeBtn" class="btn primary" type="button">Close</button>
          <a id="loginLink" class="btn" href="{{ url_for('auth.login') }}">Back to login</a>
        </div>
      </div>
    </div>
    <script>
      (function(){
        // Clear local caches and counters
        try { localStorage.removeItem('tm_last_msgs'); localStorage.removeItem('tm_last_appr'); } catch(e){}
        if ('caches' in window) { try { caches.keys().then(keys=>Promise.all(keys.map(k=>caches.delete(k)))).catch(()=>{}); } catch(e){} }
        if ('serviceWorker' in navigator) {
          try {
            navigator.serviceWorker.getRegistrations().then(list => { list.forEach(r => r.unregister()); }).catch(()=>{});
          } catch(e){}
        }
        const loginURL = document.getElementById('loginLink').href;
        function tryClose(){
          const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator && window.navigator.standalone === true);
          // multiple attempts via different window contexts
          try { window.open('', '_self'); } catch(e){}
          try { window.close(); } catch(e){}
          try { window.top && window.top.close && window.top.close(); } catch(e){}
          try { window.parent && window.parent.close && window.parent.close(); } catch(e){}
          if (isStandalone) {
            try { window.close(); } catch(e){}
          }
          // If close is blocked (typical in browser tabs), fall back to login
          setTimeout(function(){
            try { window.location.replace(loginURL); } catch(e) { window.location.href = loginURL; }
          }, 500);
        }
        document.getElementById('closeBtn').addEventListener('click', tryClose);
        // Attempt automatic close shortly after load
        setTimeout(tryClose, 300);
      })();
    </script>
  </body>
</html>
