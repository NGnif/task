<!doctype html>
<html lang="{{ locale }}" dir="{{ 'rtl' if dir_rtl else 'ltr' }}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#1877F2" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>{% block title %}{{ t('app_name') }}{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=13" />
    <link rel="manifest" href="{{ url_for('pwa.manifest') }}" />
    <link rel="apple-touch-icon" href="/icons/192.png" />
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="brand"><a href="{{ url_for('main.tasks') }}">{{ t('app_name') }}</a></div>
        <button class="nav-toggle" aria-label="Menu">&#9776;</button>
        <div class="nav-right">
          {% if current_user.is_authenticated %}
            <a class="btn" href="{{ url_for('main.tasks') }}">{{ t('dashboard') if current_user.role=='owner' else t('my_tasks') }}</a>
            {% if current_user.role=='owner' %}
              <a id="approvals-link" class="btn" href="{{ url_for('main.approvals') }}">{{ t('approvals') }}{% if notif_approvals %}<span class="bubble">{{ notif_approvals }}</span>{% endif %}</a>
            {% endif %}
            <a class="btn bell {% if notif_messages %}bell-alert{% endif %}" href="{{ url_for('main.messages_root') }}" aria-label="Messages">ðŸ””{% if notif_messages %}<span class="bubble">{{ notif_messages }}</span>{% endif %}</a>
            <span class="user">{{ current_user.username }} ({{ t('owner') if current_user.role=='owner' else t('worker') }})</span>
            {% if current_user.role=='owner' %}
              <a class="btn" href="{{ url_for('main.users') }}">{{ t('users') }}</a>
              <a class="btn" href="{{ url_for('auth.register') }}">{{ t('create_user') }}</a>
            {% endif %}
            <a class="btn" href="{{ url_for('auth.change_password') }}">{{ t('change_password') }}</a>
            <a class="btn" href="{{ url_for('i18n.set_lang', locale='ar' if locale=='en' else 'en') }}">{{ 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' if locale=='en' else 'English' }}</a>
            <a class="btn" href="{{ url_for('auth.logout') }}">{{ t('logout') }}</a>
          {% else %}
            <a class="btn" href="{{ url_for('i18n.set_lang', locale='ar' if locale=='en' else 'en') }}">{{ 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' if locale=='en' else 'English' }}</a>
            <a class="btn" href="{{ url_for('auth.login') }}">{{ t('login') }}</a>
          {% endif %}
        </div>
      </div>
    </nav>

    <main class="container">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <ul class="flash">
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register("{{ url_for('pwa.service_worker') }}?v=11").catch(() => {});
        });
      }
      // Mobile nav toggle
      const navToggle = document.querySelector('.nav-toggle');
      const navBar = document.querySelector('.navbar');
      if (navToggle && navBar) {
        navToggle.addEventListener('click', () => navBar.classList.toggle('open'));
      }
    </script>
    <script>
      window.TM_NOTIF_MESSAGES = {{ notif_messages or 0 }};
      window.TM_NOTIF_APPROVALS = {{ notif_approvals or 0 }};
    </script>
    <script src="{{ url_for('static', filename='notify.js') }}?v=12"></script>
    <script>
      (function(){
        const REFRESH_MS = 10000;
        function isTyping(){
          const ae = document.activeElement;
          if (!ae) return false;
          const tag = (ae.tagName||'').toUpperCase();
          return ae.isContentEditable || tag==='INPUT' || tag==='TEXTAREA' || tag==='SELECT';
        }
        function shouldRefresh(){
          if (document.hidden) return false;
          if (isTyping()) return false;
          const p = location.pathname || '';
          return p.startsWith('/tasks') || p.startsWith('/messages') || p.startsWith('/approvals');
        }
        setInterval(()=>{ if (shouldRefresh()) { window.location.reload(); } }, REFRESH_MS);
      })();
    </script>
  </body>
  </html>
